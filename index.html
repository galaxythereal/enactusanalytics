<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enactus Menoufia Advanced Analytics Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        }

        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New styles for improved UI */
        .modal-content {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 1rem;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
        }

        .profile-body {
            padding: 2rem;
        }

        .profile-section {
            margin-bottom: 1.5rem;
        }

        .profile-section h3 {
            color: #4a5568;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Login modal styles */
        #loginModal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .login-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: 1rem;
            width: 300px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="hidden">
        <div class="login-content">
            <h2 class="text-2xl font-bold mb-4">Login</h2>
            <input type="password" id="passwordInput" placeholder="Enter password" class="w-full p-2 mb-4 border rounded">
            <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
        </div>
    </div>
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
</div>

    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Enactus Menoufia</h1>
                    <p class="text-lg">Advanced Analytics Hub</p>
                </div>
                <div class="flex space-x-4">
                    <button id="exportBtn" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition duration-300 flex items-center">
                        <i class="fas fa-download mr-2"></i>Export Report
                    </button>
                    <button id="refreshBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section class="mb-8">
            <div class="glassmorphism p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Analytics Filters</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label for="committeeFilter" class="block text-sm font-medium text-gray-700 mb-1">Committee</label>
                        <select id="committeeFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Committees</option>
                        </select>
                    </div>
                    <div>
                        <label for="facultyFilter" class="block text-sm font-medium text-gray-700 mb-1">Faculty</label>
                        <select id="facultyFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Faculties</option>
                        </select>
                    </div>
                    <div>
                        <label for="academicYearFilter" class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                        <select id="academicYearFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" id="searchInput" placeholder="Search applicants..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
        </section>
<div class="card p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Gender Distribution</h3>
    <div class="chart-container">
        <canvas id="genderChart"></canvas>
    </div>
</div>
<div class="card p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Academic Year Distribution</h3>
    <div class="chart-container">
        <canvas id="academicYearChart"></canvas>
    </div>
</div>
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-blue-500 rounded-full p-3 mr-4">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Applicants</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="totalApplicants">0</h3>
                        <span class="text-green-500 text-sm" id="applicantChange">+0%</span>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-green-500 rounded-full p-3 mr-4">
                        <i class="fas fa-venus-mars text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Gender Ratio</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="genderRatio">0:0</h3>
                        <span class="text-blue-500 text-sm">Male : Female</span>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-purple-500 rounded-full p-3 mr-4">
                        <i class="fas fa-graduation-cap text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Top Faculty</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="topFaculty">-</h3>
                        <span class="text-purple-500 text-sm" id="topFacultyPercentage">0%</span>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-500 rounded-full p-3 mr-4">
                        <i class="fas fa-chart-pie text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Popular Committee</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="popularCommittee">-</h3>
                        <span class="text-yellow-500 text-sm" id="popularCommitteePercentage">0%</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Application Timeline</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Committee Distribution</h3>
                <div class="chart-container">
                    <canvas id="committeeChart"></canvas>
                </div>
            </div>
        </section>
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="card p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Faculty Distribution</h3>
        <div class="chart-container">
            <canvas id="facultyChart"></canvas>
        </div>
    </div>
</section>
        <section class="card overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Applicants List</h3>
                <div class="flex space-x-2">
                    <button id="filterToggle" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors">
                        <i class="fas fa-filter mr-2"></i>Toggle Filters
                    </button>
                    <button id="exportTable" class="bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Table
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                       <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Committee</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
    </tr>
                    </thead>
                    <tbody id="applicantsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 flex items-center justify-between border-t border-gray-200">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span id="startRange" class="font-medium">1</span> to <span id="endRange" class="font-medium">10</span> of <span id="totalEntries" class="font-medium">0</span> entries
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </section>
    </main>

    <div id="applicantModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Applicant Profile
                            </h3>
                            <div class="mt-2">
                                <div id="modalContent">
                                    <!-- Dynamic content for applicant profile -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global variables for DOM elements
const totalApplicantsEl = document.getElementById('totalApplicants');
const genderRatioEl = document.getElementById('genderRatio');
const topFacultyEl = document.getElementById('topFaculty');
const popularCommitteeEl = document.getElementById('popularCommittee');
const startRangeEl = document.getElementById('startRange');
const endRangeEl = document.getElementById('endRange');
const totalEntriesEl = document.getElementById('totalEntries');
const applicantModal = document.getElementById('applicantModal');
const modalContentEl = document.getElementById('modalContent');
const loadingOverlay = document.getElementById('loading-overlay');
  // Global variables
let applicants = [];
let filteredApplicants = [];
let currentPage = 1;
const itemsPerPage = 10;
let currentUser = null;
let timelineChart, committeeChart, genderChart, academicYearChart, facultyChart;

const users = {
    'admin': 'admin123',
    'projects': 'projects123',
    'logistics': 'logistics123',
    'presentation': 'presentation123',
    'graphicdesign': 'graphicdesign123',
    'videophoto': 'videophoto123',
    'hr': 'hr123',
    'prfr': 'prfr123',
    'digitalmarketing': 'digitalmarketing123'
};

const filters = {
    preferredCommittee: '',
    faculty: '',
    academicYear: '',
    search: ''
};

// Function to show login modal
function showLoginModal() {
    document.getElementById('loginModal').classList.remove('hidden');
}

function login() {
    const password = document.getElementById('passwordInput').value;
    const user = Object.keys(users).find(key => users[key] === password);
    
    if (user) {
        currentUser = user;
        document.getElementById('loginModal').style.display = 'none'; // Change this line
        document.querySelector('main').style.display = 'block';
        fetchData();
    } else {
        alert('Invalid password');
    }
}

// Add this function to show the login modal
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex'; // Change this line
}


// Fetch data function
async function fetchData() {
    if (!currentUser) {
        showLoginModal();
        return;
    }

    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.style.display = 'flex';
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbz9qFKlJQ9AxBzUNE-ZrXbG_q92r-kjVBDb3D8u3HN7g-Aq7iD64KL6zkIxgimEQA/exec');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (data.status === "error") {
            throw new Error(data.message);
        }
            applicants = data.data.map(row => ({
                Timestamp: row['Timestamp'] || '',
                firstName: row['firstName'] || '',
                lastName: row['lastName'] || '',
                preferredCommittee: row['preferredCommittee'] || '',
                gender: row['gender'] || '',
                faculty: row['faculty'] || '',
                otherFaculty: row['otherFaculty'] || '',
                phone: row['phone'] || '',
                academicYear: row['academicYear'] || '',
                email: row['email'] || '',
                skills: row['skills'] || '',
                experience: row['experience'] || '',
                dob: row['dob'] || '',
                facebook: row['facebook'] || '',
                linkedin: row['linkedin'] || '',
                portfolio: row['portfolio'] || '',
                projectsQ1: row['projectsQ1'] || '',
                projectsQ2: row['projectsQ2'] || '',
                projectsQ3: row['projectsQ3'] || '',
                projectsQ4: row['projectsQ4'] || '',
                logisticsQ1: row['logisticsQ1'] || '',
                logisticsQ2: row['logisticsQ2'] || '',
                logisticsQ3: row['logisticsQ3'] || '',
                logisticsQ4: row['logisticsQ4'] || '',
                presentationQ1: row['presentationQ1'] || '',
                presentationQ2: row['presentationQ2'] || '',
                presentationQ3: row['presentationQ3'] || '',
                presentationQ4: row['presentationQ4'] || '',
                graphicDesignQ1: row['graphicDesignQ1'] || '',
                graphicDesignQ2: row['graphicDesignQ2'] || '',
                graphicDesignQ3: row['graphicDesignQ3'] || '',
                graphicDesignQ4: row['graphicDesignQ4'] || '',
                videoPhotoQ1: row['videoPhotoQ1'] || '',
                videoPhotoQ2: row['videoPhotoQ2'] || '',
                videoPhotoQ3: row['videoPhotoQ3'] || '',
                videoPhotoQ4: row['videoPhotoQ4'] || '',
                hrQ1: row['hrQ1'] || '',
                hrQ2: row['hrQ2'] || '',
                hrQ3: row['hrQ3'] || '',
                hrQ4: row['hrQ4'] || '',
                prFrQ1: row['prFrQ1'] || '',
                prFrQ2: row['prFrQ2'] || '',
                prFrQ3: row['prFrQ3'] || '',
                prFrQ4: row['prFrQ4'] || '',
                digitalMarketingQ1: row['digitalMarketingQ1'] || '',
                digitalMarketingQ2: row['digitalMarketingQ2'] || '',
                digitalMarketingQ3: row['digitalMarketingQ3'] || '',
                digitalMarketingQ4: row['digitalMarketingQ4'] || '',
                id: row['Timestamp'],
                Timestamp: new Date(row['Timestamp'] || '')
                
}));
         // Filter applicants based on user role
          if (currentUser !== 'admin') {
            applicants = applicants.filter(a => a.preferredCommittee.toLowerCase() === currentUser);
        }

        console.log('Processed applicants:', applicants);
        
        initializeDashboard();
    } catch (error) {
        console.error('Error fetching data:', error);
        alert('Failed to fetch data. Please try again later.');
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

// Initialize dashboard function
function initializeDashboard() {
    updateFilters();
    initializeCharts();
    updateDashboard();
    attachEventListeners();
}

document.addEventListener("DOMContentLoaded", function () {
    document.querySelector('main').style.display = 'none';
    showLoginModal();

    // DOM elements
    const totalApplicantsEl = document.getElementById('totalApplicants');
    const genderRatioEl = document.getElementById('genderRatio');
    const topFacultyEl = document.getElementById('topFaculty');
    const popularCommitteeEl = document.getElementById('popularCommittee');
    const startRangeEl = document.getElementById('startRange');
    const endRangeEl = document.getElementById('endRange');
    const totalEntriesEl = document.getElementById('totalEntries');
    const applicantModal = document.getElementById('applicantModal');
    const modalContentEl = document.getElementById('modalContent');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Attach event listeners
    attachEventListeners();
});

    


    function updateFilters() {
    const committees = [...new Set(applicants.map(a => a.preferredCommittee))].filter(Boolean);
    const faculties = [...new Set(applicants.map(a => a.faculty))].filter(Boolean);
    const academicYears = [...new Set(applicants.map(a => a.academicYear))].filter(Boolean);

    populateSelect('committeeFilter', committees);
    populateSelect('facultyFilter', faculties);
    populateSelect('academicYearFilter', academicYears);
}

    function populateSelect(id, options) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">All</option>';
    options.sort().forEach(option => {
        if (option) {  // Only add non-empty options
            const optionEl = document.createElement('option');
            optionEl.value = option;
            optionEl.textContent = option;
            select.appendChild(optionEl);
        }
    });
}

    function updateDashboard() {
        applyFilters();
        updateStats();
        renderTable();
        updateCharts();
    }

    function applyFilters() {
    filteredApplicants = applicants.filter(applicant => {
        const committeeMatch = !filters.preferredCommittee || 
            applicant.preferredCommittee.toLowerCase() === filters.preferredCommittee.toLowerCase();
        
        const facultyMatch = !filters.faculty || 
            applicant.faculty.toLowerCase() === filters.faculty.toLowerCase();
        
        const yearMatch = !filters.academicYear || 
            applicant.academicYear.toLowerCase() === filters.academicYear.toLowerCase();
        
        const searchMatch = !filters.search || 
            (applicant.firstName + ' ' + applicant.lastName)
                .toLowerCase()
                .includes(filters.search.toLowerCase());
        
        return committeeMatch && facultyMatch && yearMatch && searchMatch;
    });
}


  function updateStats() {
        const totalApplicants = filteredApplicants.length;
        totalApplicantsEl.textContent = totalApplicants;

        const genderCounts = filteredApplicants.reduce((acc, applicant) => {
            acc[applicant.gender] = (acc[applicant.gender] || 0) + 1;
            return acc;
        }, {});
        const maleCount = genderCounts['male'] || 0;
        const femaleCount = genderCounts['female'] || 0;
        genderRatioEl.textContent = `${maleCount}:${femaleCount}`;

        const facultyCounts = filteredApplicants.reduce((acc, applicant) => {
            acc[applicant.faculty] = (acc[applicant.faculty] || 0) + 1;
            return acc;
        }, {});
        const topFaculty = Object.entries(facultyCounts).sort((a, b) => b[1] - a[1])[0];
        topFacultyEl.textContent = topFaculty ? topFaculty[0] : '-';
        document.getElementById('topFacultyPercentage').textContent = topFaculty ? `${((topFaculty[1] / totalApplicants) * 100).toFixed(1)}%` : '0%';

        const committeeCounts = filteredApplicants.reduce((acc, applicant) => {
            acc[applicant.preferredCommittee] = (acc[applicant.preferredCommittee] || 0) + 1;
            return acc;
        }, {});
        const popularCommittee = Object.entries(committeeCounts).sort((a, b) => b[1] - a[1])[0];
        popularCommitteeEl.textContent = popularCommittee ? popularCommittee[0] : '-';
        document.getElementById('popularCommitteePercentage').textContent = popularCommittee ? `${((popularCommittee[1] / totalApplicants) * 100).toFixed(1)}%` : '0%';
    }

function renderTable() {
    const tbody = document.getElementById('applicantsTableBody');
    tbody.innerHTML = '';
const sortedApplicants = filteredApplicants.sort((a, b) => b.Timestamp - a.Timestamp);
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageApplicants = filteredApplicants.slice(start, end);

    pageApplicants.forEach(applicant => {
        const row = `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${applicant.firstName} ${applicant.lastName}</td>
                <td class="px-6 py-4 whitespace-nowrap">${applicant.preferredCommittee}</td>
                <td class="px-6 py-4 whitespace-nowrap">${applicant.faculty}</td>
                <td class="px-6 py-4 whitespace-nowrap">${applicant.academicYear}</td>
                <td class="px-6 py-4 whitespace-nowrap">${formatDate(applicant.Timestamp)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewProfile('${applicant.id}')" class="text-indigo-600 hover:text-indigo-900">View Profile</button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });

    updatePagination();
}

    
function formatDate(date) {
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
    function updatePagination() {
        const totalPages = Math.ceil(filteredApplicants.length / itemsPerPage);
        startRangeEl.textContent = ((currentPage - 1) * itemsPerPage) + 1;
        endRangeEl.textContent = Math.min(currentPage * itemsPerPage, filteredApplicants.length);
        totalEntriesEl.textContent = filteredApplicants.length;

        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
    }


function initializeCharts() {
    // Timeline Chart
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    if (timelineChart instanceof Chart) {
        timelineChart.destroy();
    }
    timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Applications',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Committee Chart
    const committeeCtx = document.getElementById('committeeChart').getContext('2d');
    if (committeeChart instanceof Chart) {
        committeeChart.destroy();
    }
    committeeChart = new Chart(committeeCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Gender Chart
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    if (genderChart instanceof Chart) {
        genderChart.destroy();
    }
    genderChart = new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
// Faculty Chart
    const facultyCtx = document.getElementById('facultyChart').getContext('2d');
    facultyChart = new Chart(facultyCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Applicants',
                data: [],
                backgroundColor: 'rgba(153, 102, 255, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });


    // Year Chart
    const academicYearCtx = document.getElementById('academicYearChart').getContext('2d');
    if (academicYearChart instanceof Chart) {
        academicYearChart.destroy();
    }
    academicYearChart = new Chart(academicYearCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Students',
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

    function updateCharts() {
        // Update Timeline Chart
        if (!timelineChart || !committeeChart) {
        console.error('Charts are not initialized');
        return;
    }
        document.getElementById('timelineChart').classList.add('loading');
    document.getElementById('committeeChart').classList.add('loading');
        const applicationDates = filteredApplicants.map(a => a.applicationDate).sort();
        const dateCountMap = applicationDates.reduce((acc, date) => {
            acc[date] = (acc[date] || 0) + 1;
            return acc;
        }, {});

        timelineChart.data.labels = Object.keys(dateCountMap);
        timelineChart.data.datasets[0].data = Object.values(dateCountMap);
        timelineChart.update();
 // Update Faculty Chart
    const facultyCounts = filteredApplicants.reduce((acc, applicant) => {
        acc[applicant.faculty] = (acc[applicant.faculty] || 0) + 1;
        return acc;
    }, {});
    facultyChart.data.labels = Object.keys(facultyCounts);
    facultyChart.data.datasets[0].data = Object.values(facultyCounts);
    facultyChart.update();

   
        // Update Committee Chart
        const committeeCounts = filteredApplicants.reduce((acc, applicant) => {
            acc[applicant.preferredCommittee] = (acc[applicant.preferredCommittee] || 0) + 1;
            return acc;
        }, {});

        committeeChart.data.labels = Object.keys(committeeCounts);
        committeeChart.data.datasets[0].data = Object.values(committeeCounts);
        committeeChart.update();
        const genderCounts = filteredApplicants.reduce((acc, applicant) => {
        acc[applicant.gender] = (acc[applicant.gender] || 0) + 1;
        return acc;
    }, {});
    genderChart.data.labels = Object.keys(genderCounts);
    genderChart.data.datasets[0].data = Object.values(genderCounts);
    genderChart.update();

    // Update Year Chart
    const academicYearCounts = filteredApplicants.reduce((acc, applicant) => {
        acc[applicant.academicYear] = (acc[applicant.academicYear] || 0) + 1;
        return acc;
    }, {});
    academicYearChart.data.labels = Object.keys(academicYearCounts);
    academicYearChart.data.datasets[0].data = Object.values(academicYearCounts);
    academicYearChart.update();
    }
document.getElementById('applicantsTableBody').addEventListener('click', function(event) {
    if (event.target.classList.contains('view-profile-btn')) {
        const id = event.target.dataset.id;
        viewProfile(id);
    }
});
    function attachEventListeners() {
        document.getElementById('committeeFilter').addEventListener('change', handleFilterChange);
        document.getElementById('facultyFilter').addEventListener('change', handleFilterChange);
        document.getElementById('academicYearFilter').addEventListener('change', handleFilterChange);
        document.getElementById('searchInput').addEventListener('input', handleFilterChange);
        document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
        document.getElementById('nextPage').addEventListener('click', () => changePage(1));
        document.getElementById('exportBtn').addEventListener('click', exportReport);
        document.getElementById('refreshBtn').addEventListener('click', fetchData);
        document.getElementById('closeModal').addEventListener('click', closeModal);
    }

    function handleFilterChange(event) {
    const filterId = event.target.id;
    let filterValue = event.target.value;
    
    switch(filterId) {
        case 'committeeFilter':
            filters.preferredCommittee = filterValue;
            break;
        case 'facultyFilter':
            filters.faculty = filterValue;
            break;
        case 'academicYearFilter':
            filters.academicYear = filterValue;
            break;
        case 'searchInput':
            filters.search = filterValue;
            break;
    }
    
    currentPage = 1;
    updateDashboard();
}

    function changePage(direction) {
        currentPage += direction;
        renderTable();
    }

// Define viewProfile in the global scope
// Define viewProfile in the global scope
 // Modify the viewProfile function
window.viewProfile = function(id) {
    const applicant = applicants.find(a => a.id === id);
    if (!applicant) return;

    const modalContent = `
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="profile-header">
                <h2 class="text-3xl font-bold">${applicant.firstName} ${applicant.lastName}</h2>
                <p class="text-lg opacity-75">${applicant.preferredCommittee}</p>
            </div>
            <div class="profile-body">
                <div class="profile-section">
                    <h3>Contact Information</h3>
                    <p><i class="fas fa-envelope mr-2"></i>${applicant.email}</p>
                    <p><i class="fas fa-phone mr-2"></i>${applicant.phone}</p>
                </div>
                <div class="profile-section">
                    <h3>Personal Details</h3>
                    <p><i class="fas fa-user mr-2"></i>${applicant.gender}</p>
                    <p><i class="fas fa-calendar mr-2"></i>${applicant.dob}</p>
                </div>
                <div class="profile-section">
                    <h3>Academic Information</h3>
                    <p><i class="fas fa-university mr-2"></i>${applicant.faculty}${applicant.otherFaculty ? ` - ${applicant.otherFaculty}` : ''}</p>
                    <p><i class="fas fa-graduation-cap mr-2"></i>${applicant.academicYear}</p>
                </div>
                <div class="profile-section">
                    <h3>Skills & Experience</h3>
                    <p class="whitespace-pre-wrap">${applicant.skills}</p>
                    <p class="mt-2 whitespace-pre-wrap">${applicant.experience}</p>
                </div>
                <div class="profile-section">
                    <h3>Social Media & Portfolio</h3>
                    ${applicant.facebook ? `<p><a href="${applicant.facebook}" target="_blank" class="text-blue-600 hover:underline"><i class="fab fa-facebook mr-2"></i>Facebook</a></p>` : ''}
                    ${applicant.linkedin ? `<p><a href="${applicant.linkedin}" target="_blank" class="text-blue-600 hover:underline"><i class="fab fa-linkedin mr-2"></i>LinkedIn</a></p>` : ''}
                    ${applicant.portfolio ? `<p><a href="${applicant.portfolio}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-briefcase mr-2"></i>Portfolio</a></p>` : ''}
                </div>
                <div class="profile-section">
                    <h3>Application Details</h3>
                    <p><i class="fas fa-clock mr-2"></i>Submitted on ${new Date(applicant.Timestamp).toLocaleString()}</p>
                </div>
                <div class="profile-section">
                    <h3>Committee-Specific Questions</h3>
                    ${generateCommitteeQuestions(applicant)}
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('applicantModal').classList.remove('hidden');
};


    // Call showLoginModal() when the page loads
    document.addEventListener('DOMContentLoaded', showLoginModal);

function generateCommitteeQuestions(applicant) {
    const committeeMap = {
        'Projects': 'projects',
        'Logistics': 'logistics',
        'Presentation': 'presentation',
        'GraphicDesign': 'graphicDesign',
        'VideoPhoto': 'videoPhoto',
        'HR': 'hr',
        'HumanResources': 'hr',
        'PR&FR': 'prFr',
        'PublicRelations&Fundraising': 'prFr', 
        'VideoEditing&Photgraphy': 'videoPhoto', // Add alternate names
        'PublicRelationsFundraising': 'prFr' // No special characters version
    };

    // Normalize the input: trim spaces and remove extra whitespace
    const normalizedCommittee = applicant.preferredCommittee.replace(/\s+/g, '').trim();
    
    // Try to map the committee, fallback to empty string if not found
    const committee = committeeMap[normalizedCommittee] || '';

    console.log('Preferred Committee (Normalized):', normalizedCommittee);
    console.log('Mapped Committee:', committee);

    // If no valid committee is found, return an error message
    if (!committee) {
        console.log('No valid committee found for:', normalizedCommittee);
        return '<p>No valid committee-specific questions available.</p>';
    }

    // Generate the question keys based on the mapped committee
    const questions = [
        `${committee}Q1`,
        `${committee}Q2`,
        `${committee}Q3`,
        `${committee}Q4`,
        
    ];

    console.log('Generated Question Keys:', questions);

    let output = '';
    // Loop through the generated questions and check if the applicant answered them
    questions.forEach((q, index) => {
        console.log(`Checking question: ${q}, Value: ${applicant[q]}`);
        if (applicant[q]) {
            output += `
                <div class="mb-4">
                    <p class="font-semibold">Question ${index + 1}:</p>
                    <p class="whitespace-pre-wrap">${applicant[q]}</p>
                </div>
            `;
        }
    });

    // Logging the final output before returning
    console.log('Generated Output:', output);

    // Return the output or the fallback message if no questions were found
    return output || '<p>No committee-specific questions available.</p>';
}



    function closeModal() {
        applicantModal.classList.add('hidden');
    }

    function exportReport() {
    const csvContent = [
        ['Name', 'Email', 'Committee', 'Faculty', 'Year', 'Gender', 'Application Date'],
        ...filteredApplicants.map(a => [
            `${a.firstName} ${a.lastName}`,
            a.email,
            a.preferredCommittee,
            a.faculty,
            a.academicYear,
            a.gender,
            a.Timestamp
        ])
    ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'enactus_applicants_report.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    // Initial data fetch
    fetchData();
</script>
</body>
</html>
